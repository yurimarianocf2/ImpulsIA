{
  "name": "FarmaBot IA - Chat Inteligente V2",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-ai",
        "responseMode": "onReceived"
      },
      "name": "WhatsApp Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "farmabot-ai"
    },
    {
      "parameters": {
        "functionCode": "// Extrair dados da mensagem WhatsApp\nconst data = $input.first().json;\n\n// Formato padr√£o do WhatsApp Business API\nconst telefone = data.from || data.phone || '5511999999999';\nconst mensagem = data.text?.body || data.message || data.text || '';\nconst nomeContato = data.profile?.name || data.name || 'Cliente';\nconst timestamp = data.timestamp || new Date().toISOString();\n\nconsole.log('üì± Mensagem recebida:', {\n  telefone,\n  mensagem,\n  nomeContato,\n  timestamp\n});\n\nreturn {\n  telefone: telefone.replace(/\\D/g, ''), // Limpar n√∫mero\n  mensagem: mensagem.trim(),\n  nomeContato,\n  timestamp,\n  conversaId: `conv_${telefone.replace(/\\D/g, '')}_${Date.now()}`\n};"
      },
      "name": "Processar WhatsApp",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [440, 300]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://fcdfunvzoxhobfskwsag.supabase.co/rest/v1/clientes",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "telefone",
              "value": "=eq.{{$json.telefone}}"
            },
            {
              "name": "select",
              "value": "id,nome,telefone,email,total_pedidos,valor_total_gasto,segmento,ultimo_pedido_at,ativo"
            }
          ]
        },
        "options": {},
        "headerAuth": {
          "name": "Authorization",
          "value": "=Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZGZ1bnZ6b3hob2Jmc2t3c2FnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDM2NjgzNywiZXhwIjoyMDY1OTQyODM3fQ.NWuWMHMM_VCyeiEl8NPRxCg3I9gx7owyKy3nHprrskQ"
        }
      },
      "name": "Buscar Cliente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [640, 300]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://fcdfunvzoxhobfskwsag.supabase.co/rest/v1/produtos",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "id,nome,nome_generico,laboratorio,dosagem,apresentacao,preco_venda,estoque_atual,categoria,subcategoria,principio_ativo,indicacoes,tags"
            },
            {
              "name": "limit",
              "value": "50"
            },
            {
              "name": "order",
              "value": "preco_venda.asc"
            }
          ]
        },
        "headerAuth": {
          "name": "Authorization",
          "value": "=Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZGZ1bnZ6b3hob2Jmc2t3c2FnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDM2NjgzNywiZXhwIjoyMDY1OTQyODM3fQ.NWuWMHMM_VCyeiEl8NPRxCg3I9gx7owyKy3nHprrskQ"
        }
      },
      "name": "Buscar Produtos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [640, 120]
    },
    {
      "parameters": {
        "model": "gpt-4",
        "messages": {
          "messageValues": [
            {
              "role": "system",
              "content": "=Voc√™ √© **FarmaBot**, assistente virtual inteligente da **Farm√°cia S√£o Jo√£o**.\\n\\nü§ñ **PERSONALIDADE:**\\n- Emp√°tico, profissional e acolhedor\\n- Especialista em produtos farmac√™uticos\\n- Comunica√ß√£o clara e objetiva\\n- SEGURAN√áA DO PACIENTE √© prioridade absoluta\\n\\nüíä **SUAS FUN√á√ïES PRINCIPAIS:**\\n1. üîç **CONSULTAR PRE√áOS E ESTOQUE** em tempo real\\n2. üìã **ORIENTA√á√ïES SOBRE MEDICAMENTOS** (bula, indica√ß√µes)\\n3. üõí **PROCESSAR RESERVAS E PEDIDOS**\\n4. üìû **TRANSFERIR PARA FARMAC√äUTICO** quando necess√°rio\\n5. üè• **COMPARAR PRE√áOS** com outras farm√°cias\\n\\nüë§ **CONTEXTO DO CLIENTE ATUAL:**\\n{{$('Buscar Cliente').first().json.length > 0 ? `üëã **Cliente:** ${$('Buscar Cliente').first().json[0].nome || 'N√£o identificado'}\\nüì± **Telefone:** ${$('Buscar Cliente').first().json[0].telefone}\\nüìä **Hist√≥rico:** ${$('Buscar Cliente').first().json[0].total_pedidos || 0} pedidos anteriores\\nüè∑Ô∏è **Perfil:** ${$('Buscar Cliente').first().json[0].segmento || 'Novo cliente'}\\nüõí **√öltima compra:** ${$('Buscar Cliente').first().json[0].ultimo_pedido_at || 'Primeira visita'}` : 'üÜï **Cliente novo** - Primeira intera√ß√£o na Farm√°cia S√£o Jo√£o'}}\\n\\nüíä **PRODUTOS EM ESTOQUE (Base Real Supabase):**\\n{{$('Buscar Produtos').first().json.map(produto => `‚Ä¢ ${produto.nome} ${produto.dosagem} (${produto.apresentacao}) - **R$ ${produto.preco_venda}** ${produto.estoque_atual > 10 ? '‚úÖ' : produto.estoque_atual > 0 ? '‚ö†Ô∏è' : '‚ùå'} ${produto.estoque_atual} unid`).join('\\n')}}\\n\\n‚ö†Ô∏è **REGRAS R√çGIDAS DE SEGURAN√áA:**\\n- üö´ **MEDICAMENTOS CONTROLADOS**: SEMPRE exigir receita m√©dica v√°lida\\n- üö´ **NUNCA d√™ conselhos m√©dicos** - apenas informa√ß√µes do produto\\n- üìû **SEMPRE transfira para farmac√™utico** em d√∫vidas t√©cnicas\\n- üí∞ **SEMPRE mencione pre√ßos atualizados** da base de dados\\n- üìä **SEMPRE verifique estoque** antes de confirmar\\n\\nüìù **FORMATO DE RESPOSTA OBRIGAT√ìRIO:**\\n1. üëã Sauda√ß√£o personalizada (se cliente conhecido)\\n2. üîç Resultados da consulta com pre√ßos reais\\n3. üìä Compara√ß√£o com concorrentes (estimativa +15-20%)\\n4. üí° Pr√≥ximas a√ß√µes claras (reservar, falar com farmac√™utico, etc.)\\n5. üéØ Sempre termine perguntando como mais pode ajudar"
            },
            {
              "role": "user", 
              "content": "={{$('Processar WhatsApp').first().json.mensagem}}"
            }
          ]
        },
        "options": {}
      },
      "name": "ChatGPT - IA Farm√°cia",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [1040, 300],
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials",
          "name": "OpenAI GPT-4"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Processar resposta da IA e detectar inten√ß√µes\nconst respostaIA = $('ChatGPT - IA Farm√°cia').first().json.message?.content || $('ChatGPT - IA Farm√°cia').first().json.text || '';\nconst dadosCliente = $('Processar WhatsApp').first().json;\nconst cliente = $('Buscar Cliente').first().json[0] || null;\nconst produtos = $('Buscar Produtos').first().json || [];\n\n// Detectar se √© consulta de pre√ßo\nconst isConsultaPreco = /pre√ßo|quanto custa|valor|custo/i.test(dadosCliente.mensagem);\n\n// Detectar produtos mencionados\nconst produtosMencionados = [];\nconst produtosBase = ['dipirona', 'paracetamol', 'ibuprofeno', 'omeprazol', 'pantoprazol', 'amoxicilina', 'azitromicina', 'vitamina', 'complexo b', 'metformina'];\n\nprodutosBase.forEach(produto => {\n  if (dadosCliente.mensagem.toLowerCase().includes(produto)) {\n    produtosMencionados.push(produto);\n  }\n});\n\n// Enriquecer resposta se for consulta de pre√ßo\nlet respostaFinal = respostaIA;\n\nif (isConsultaPreco && produtosMencionados.length > 0) {\n  respostaFinal += `\\n\\nüìã *A√á√ïES DISPON√çVEIS:*\\n1Ô∏è‚É£ Reservar produto\\n2Ô∏è‚É£ Ver bula/informa√ß√µes\\n3Ô∏è‚É£ Falar com farmac√™utico\\n4Ô∏è‚É£ Ver produtos similares\\n\\nüí¨ Digite o n√∫mero da op√ß√£o ou me diga como posso ajudar!`;\n}\n\n// Adicionar sauda√ß√£o personalizada para clientes conhecidos\nif (cliente && cliente.nome) {\n  respostaFinal = `Ol√° ${cliente.nome}! üòä\\n\\n` + respostaFinal;\n} else if (!cliente) {\n  respostaFinal = `Ol√°! Bem-vindo √† Farm√°cia S√£o Jo√£o! üëã\\n\\n` + respostaFinal;\n}\n\n// Adicionar informa√ß√µes de estoque baixo se relevante\nconst produtosBaixoEstoque = produtos.filter(p => p.estoque_atual <= 5);\nif (produtosBaixoEstoque.length > 0 && isConsultaPreco) {\n  respostaFinal += `\\n\\n‚ö†Ô∏è *ATEN√á√ÉO - Estoque limitado:*\\n${produtosBaixoEstoque.map(p => `‚Ä¢ ${p.nome} - Apenas ${p.estoque_atual} unidades`).join('\\n')}`;\n}\n\nconsole.log('ü§ñ Resposta processada:', {\n  cliente: cliente?.nome || 'Novo',\n  isConsultaPreco,\n  produtosMencionados,\n  tamanhoResposta: respostaFinal.length,\n  produtosBaixoEstoque: produtosBaixoEstoque.length\n});\n\nreturn {\n  telefone: dadosCliente.telefone,\n  resposta: respostaFinal,\n  isConsultaPreco,\n  produtosMencionados,\n  cliente: cliente,\n  produtosBaixoEstoque,\n  metadata: {\n    timestamp: new Date().toISOString(),\n    modelo: 'gpt-4',\n    tokens: respostaIA.length,\n    intent: isConsultaPreco ? 'consulta_preco' : 'conversa_geral',\n    produtos_encontrados: produtos.length\n  }\n};"
      },
      "name": "Processar Resposta IA",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1240, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://fcdfunvzoxhobfskwsag.supabase.co/rest/v1/mensagens",
        "authentication": "headerAuth",
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"conversa_id\": \"{{$('Processar WhatsApp').first().json.conversaId}}\",\n  \"tipo\": \"recebida\",\n  \"conteudo\": \"{{$('Processar WhatsApp').first().json.mensagem}}\",\n  \"intent\": \"{{$json.metadata.intent}}\",\n  \"processed\": true,\n  \"metadata\": {{JSON.stringify($json.metadata)}}\n}",
        "headerAuth": {
          "name": "Authorization",
          "value": "=Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZGZ1bnZ6b3hob2Jmc2t3c2FnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDM2NjgzNywiZXhwIjoyMDY1OTQyODM3fQ.NWuWMHMM_VCyeiEl8NPRxCg3I9gx7owyKy3nHprrskQ"
        },
        "options": {}
      },
      "name": "Salvar Mensagem Recebida",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1440, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://fcdfunvzoxhobfskwsag.supabase.co/rest/v1/mensagens",
        "authentication": "headerAuth",
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"conversa_id\": \"{{$('Processar WhatsApp').first().json.conversaId}}\",\n  \"tipo\": \"enviada\",\n  \"conteudo\": \"{{$json.resposta}}\",\n  \"resposta_automatica\": true,\n  \"processed\": true,\n  \"metadata\": {{JSON.stringify($json.metadata)}}\n}",
        "headerAuth": {
          "name": "Authorization",
          "value": "=Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZGZ1bnZ6b3hob2Jmc2t3c2FnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDM2NjgzNywiZXhwIjoyMDY1OTQyODM3fQ.NWuWMHMM_VCyeiEl8NPRxCg3I9gx7owyKy3nHprrskQ"
        },
        "options": {}
      },
      "name": "Salvar Resposta Enviada",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1440, 400]
    },
    {
      "parameters": {
        "functionCode": "// Preparar resposta final para WhatsApp\nconst dados = $input.first().json;\n\n// Limitar tamanho da mensagem (WhatsApp tem limite)\nlet resposta = dados.resposta;\nif (resposta.length > 4000) {\n  resposta = resposta.substring(0, 3900) + '...\\n\\nüí¨ Resposta muito longa! Digite \"mais info\" para continuar.';\n}\n\n// Adicionar assinatura da farm√°cia\nresposta += '\\n\\n---\\nüè• *Farm√°cia S√£o Jo√£o*\\nüì± Atendimento 24h via WhatsApp\\nüìç Sempre os melhores pre√ßos!';\n\nconsole.log('‚úÖ Resposta final preparada:', {\n  telefone: dados.telefone,\n  tamanho: resposta.length,\n  intent: dados.metadata?.intent,\n  produtos_mencionados: dados.produtosMencionados?.length || 0\n});\n\nreturn {\n  to: dados.telefone,\n  message: resposta,\n  success: true,\n  timestamp: new Date().toISOString(),\n  intent: dados.metadata?.intent,\n  produtos_encontrados: dados.metadata?.produtos_encontrados\n};"
      },
      "name": "Preparar Resposta Final",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1640, 300]
    }
  ],
  "connections": {
    "WhatsApp Webhook": {
      "main": [
        [
          {
            "node": "Processar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar WhatsApp": {
      "main": [
        [
          {
            "node": "Buscar Cliente",
            "type": "main",
            "index": 0
          },
          {
            "node": "Buscar Produtos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Cliente": {
      "main": [
        [
          {
            "node": "ChatGPT - IA Farm√°cia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Produtos": {
      "main": [
        [
          {
            "node": "ChatGPT - IA Farm√°cia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatGPT - IA Farm√°cia": {
      "main": [
        [
          {
            "node": "Processar Resposta IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Resposta IA": {
      "main": [
        [
          {
            "node": "Salvar Mensagem Recebida",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar Resposta Enviada",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Resposta Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}